# PharmaMax - Google Cloud Run Deployment Guide

## Prerequisites

1. Google Cloud CLI installed: https://cloud.google.com/sdk/docs/install
2. Docker installed locally for testing
3. Google Cloud project with Cloud Run API enabled
4. OpenAI API key

## Environment Variables Required

- OPENAI_API_KEY: Your OpenAI API key for SIG parsing

## Local Docker Testing

1. Build the Docker image:
   docker build -t pharmamax .

2. Run locally with environment variables:
   docker run -p 3000:3000 -e OPENAI_API_KEY=your-key-here pharmamax

3. Test the application at http://localhost:3000

## Deploy to Google Cloud Run

### Option 1: Using gcloud CLI (Recommended)

1. Set your project:
   gcloud config set project YOUR_PROJECT_ID

2. Build and deploy in one command:
   gcloud run deploy pharmamax \
     --source . \
     --platform managed \
     --region us-central1 \
     --allow-unauthenticated \
     --set-env-vars OPENAI_API_KEY=your-key-here

3. The deployment will:
   - Build the Docker image using Cloud Build
   - Deploy to Cloud Run
   - Provide you with a public URL

### Option 2: Using Cloud Build + Cloud Run

1. Build the image with Cloud Build:
   gcloud builds submit --tag gcr.io/YOUR_PROJECT_ID/pharmamax

2. Deploy to Cloud Run:
   gcloud run deploy pharmamax \
     --image gcr.io/YOUR_PROJECT_ID/pharmamax \
     --platform managed \
     --region us-central1 \
     --allow-unauthenticated \
     --set-env-vars OPENAI_API_KEY=your-key-here

### Option 3: Using Console UI

1. Go to: https://console.cloud.google.com/run
2. Click "Create Service"
3. Select "Continuously deploy from a repository"
4. Connect your Git repository
5. Configure:
   - Region: us-central1
   - Authentication: Allow unauthenticated
   - Container port: 3000
   - Environment variables: Add OPENAI_API_KEY
6. Click "Create"

## Setting Environment Variables in Cloud Run

### Via gcloud:
gcloud run services update pharmamax \
  --set-env-vars OPENAI_API_KEY=your-key-here \
  --region us-central1

### Via Console:
1. Go to your service in Cloud Run
2. Click "Edit & Deploy New Revision"
3. Go to "Variables & Secrets" tab
4. Add environment variables
5. Deploy

## Using Secret Manager (Recommended for Production)

1. Create secret:
   echo -n "your-api-key" | gcloud secrets create openai-api-key --data-file=-

2. Grant Cloud Run access:
   gcloud secrets add-iam-policy-binding openai-api-key \
     --member="serviceAccount:YOUR_PROJECT_NUMBER-compute@developer.gserviceaccount.com" \
     --role="roles/secretmanager.secretAccessor"

3. Deploy with secret:
   gcloud run deploy pharmamax \
     --source . \
     --set-secrets=OPENAI_API_KEY=openai-api-key:latest \
     --region us-central1

## Configuration Options

- CPU: 1 (default, can increase for better performance)
- Memory: 512Mi (default, can increase if needed)
- Max instances: 100 (can adjust based on expected load)
- Min instances: 0 (keep costs low, set to 1+ for faster response)
- Timeout: 300s (default, adjust if needed)

## Monitoring and Logs

View logs:
gcloud run services logs read pharmamax --region us-central1

View metrics in Cloud Console:
https://console.cloud.google.com/run

## Cost Optimization

- Free tier: 2 million requests/month
- Pay only for actual usage (when requests are being served)
- Set max instances to control costs
- Use min instances = 0 for dev/testing

## Troubleshooting

1. If deployment fails, check logs:
   gcloud run services logs tail pharmamax --region us-central1

2. If app doesn't start, verify:
   - OPENAI_API_KEY is set correctly
   - Container listens on PORT environment variable (defaults to 3000)
   - Docker image builds successfully locally

3. Common issues:
   - Missing API key: Add OPENAI_API_KEY
   - Port mismatch: Ensure app listens on process.env.PORT
   - Build errors: Test Docker build locally first

## Updating the Application

1. Make code changes
2. Redeploy:
   gcloud run deploy pharmamax --source . --region us-central1

Cloud Run will automatically:
- Build new Docker image
- Deploy with zero downtime
- Route traffic to new version

## Domain Mapping (Optional)

1. Verify domain:
   gcloud domains verify YOUR_DOMAIN

2. Map domain:
   gcloud run domain-mappings create --service pharmamax --domain YOUR_DOMAIN

## Health Checks

Cloud Run automatically performs health checks on:
- Startup: Container must start within timeout
- Liveness: Regular health checks during runtime

The SvelteKit app responds to HTTP requests, which serves as the health check.
